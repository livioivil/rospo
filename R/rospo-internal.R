.convertAny2SVD <-
function(SV){
#   if(is.svd(SV)){
#     #rinomina e riscala per generare gli score
#     names(SV)[which.hasname(SV,"u")]="x"
#     SV$x=SV$x%*%diag(SV$d)*sqrt(nrow(SV$x))
#     SV$x=.fix.col.pc.names(SV$x)
#     #dev std delle SV
#     names(SV)[which.hasname(SV,"d")]="sdev"
#     #matrice loadings
#     names(SV)[which.hasname(SV,"v")]="rotation"    
#     SV$rotation=.fix.col.pc.names(SV$rotation)
#   }
  
  if(is(SV,"princomp")){
    #rinomina e riscala per generare gli score
    names(SV)[which.hasname(SV,"scores")]="u"
    SV$u=SV$u%*%diag(1/SV$sdev)/sqrt(nrow(SV$u))
    #dev std delle SV
    names(SV)[which.hasname(SV,"sdev")]="d"
    #matrice loadings
    names(SV)[which.hasname(SV,"loadings")]="v"    
  }  
  if(is(SV,"prcomp")){
    #rinomina e riscala per generare gli score
    names(SV)[which.hasname(SV,"x")]="u"
    SV$u=SV$u%*%diag(1/SV$sdev)/sqrt(nrow(SV$u))
    #dev std delle SV
    names(SV)[which.hasname(SV,"sdev")]="d"
    #matrice loadings
    names(SV)[which.hasname(SV,"rotation")]="v"    
  }  
  
  SV$u=.fix.names(SV$u,1,"")
  SV$v=.fix.names(SV$v,2,"Pc")
  SV$v=.fix.names(SV$v,1,"Var")
  SV
}
.fix.col.pc.names <-
function(mat){
  if(is.null(colnames(mat))) 
    colnames(mat)=paste("PC",1:ncol(mat),sep="")
  mat
}
.fix.names <-
function(mat,ndim=1,prefix="PC"){
  if(is.null(dimnames(mat)[[ndim]])) 
    dimnames(mat)[[ndim]]=paste(prefix,1:dim(mat)[ndim],sep="")
  mat
}
.get.legend.opt <-
function(legend.opt,obs.opt){
  identificatori.gruppi=c("col","bg","pch")

  leg.elements=unique(as.data.frame(obs.opt[identificatori.gruppi]),MARGIN = 1)
  if((nrow(leg.elements)<=1)&&(is.null(legend.opt)))
    legend.opt=NULL else 
      { 
        #legent.opt default
        if(is.null(legend.opt)){
           legend.opt=as.list(rep(NA,length(identificatori.gruppi)+1))
           names(legend.opt)=c(identificatori.gruppi,"x")
           legend.opt$x="bottomleft"
           }
        elementi.variabili=names(which(apply(leg.elements,2,function(x)length(unique(x))>1)))
        legend.opt$legend=apply(leg.elements[,elementi.variabili,drop=FALSE],1,paste,collapse="-")

        for (i in setdiff(identificatori.gruppi,names(which(!is.na(legend.opt)))))
          legend.opt[[i]]=leg.elements[,i]
#         names(legend.opt)[which(names(legend.opt)=="bg")]="fill"
        if(is.null(legend.opt$bty)) legend.opt$bty="n"
   }
  legend.opt
}
.get.obs.opt <-
function(obs.opt,obs.col.palette=NULL,SV){
  
  #   if(is.null(var.suppl.opt$col)) var.suppl.color=greyUnipd
  if(is.null(obs.opt$names)) obs.names=FALSE
  if(is.logical(obs.opt$names) && (obs.opt$names==TRUE)) 
    obs.opt$obs.names=if(is.null(row.names(SV$x))) 
      as.character(1:n) else row.names(SV$x)
  
  if(is.null(obs.opt$col)) obs.opt$col=1
  if(obs.opt$col[1]=="each.obs")
    obs.opt$col=1:n

  if(is.null(obs.opt$pch)) obs.opt$pch=20
  
  if(is.null(obs.opt$bg)) obs.opt$bg=1
  if(obs.opt$bg[1]=="each.obs")
    obs.opt$bg=1:n
  
  if(!is.null(obs.col.palette))
      palette(obs.col.palette) 
  obs.opt
}
.get.var.opt <-
function(var.opt,var.col.palette,SV){
  if(is.null(var.opt$names)) var.names=rownames(SV$rotation)
  if(is.null(var.opt$col)) var.opt$col=2
  if(!is.null(var.col.palette))
    palette(var.col.palette) 
  var.opt
}
.Random.seed <-
c(403L, 348L, -645177075L, 800461730L, -813776585L, -650814882L, 
1537733277L, 887014687L, 2114373973L, -536517589L, -829985214L, 
-452202158L, -1324761469L, -528610640L, -553571672L, -552524455L, 
-1453441627L, 813736236L, -2040413505L, -1736281621L, -650869272L, 
-1431625429L, 1804818101L, -262374304L, -1453017865L, 1030583258L, 
2130290251L, 103514941L, 1109278050L, -1827703079L, -151802868L, 
344064382L, -1497003620L, 1922757239L, 1946543489L, 536637164L, 
248159951L, 863149461L, -1073000369L, 1309777614L, -2140020199L, 
-797171789L, -503020354L, 1546032875L, -667718316L, 381940748L, 
-217227503L, 1597569149L, -2082994785L, -110207591L, -1775439377L, 
1502153664L, 508282083L, -1272285022L, 1705321665L, -2093401574L, 
1620141461L, -718284625L, -597984050L, 1267070884L, -462221975L, 
1112089013L, 732929850L, -1305683315L, 1244005306L, -1465815838L, 
1215560655L, -312245921L, 435715634L, -2043465438L, 2027277911L, 
-1121868633L, -405824427L, 577515518L, -1552108419L, 1180262342L, 
906048004L, 1668179628L, 1516884992L, 1645423233L, -123349231L, 
-1562117815L, 1697791674L, 1923712106L, 1042423410L, 1021642785L, 
2036297834L, 1072928850L, 770440526L, 1100613082L, -1039856213L, 
-1381085000L, -286386141L, -480481100L, -1791750318L, -103283670L, 
-983850550L, -53280674L, -1178023370L, -959554324L, -1709049848L, 
1503104428L, -1917193386L, -2074501570L, 1309582325L, 789620403L, 
-1781661537L, 270409853L, 177265001L, 1552261538L, -1819947096L, 
230761047L, -1838683683L, 1120165013L, 877773070L, 618355980L, 
-1629882238L, 2082323901L, -977597549L, -1403774822L, 25060467L, 
1776417875L, 895602203L, 1780163633L, 106996101L, -180526655L, 
1823852908L, -1104281057L, -1516650792L, 2001065558L, -2061251971L, 
-2065895510L, 1692838968L, -1610762312L, 238140405L, -2127669300L, 
-431868918L, 1960457926L, 1309938041L, 578577351L, -619669328L, 
2048833627L, 1505782726L, 399581967L, -528648131L, -120591660L, 
684330005L, -1360617360L, 661726423L, -1633445409L, 27025901L, 
-1846285055L, 1804555623L, -1903973978L, 604429464L, 1671114954L, 
-559276753L, -1517569850L, -884721922L, 1084584535L, 1375116103L, 
1222980632L, 386389388L, -1689878095L, 55504258L, -1433513165L, 
-2092667607L, -1466805298L, 556870792L, -1315323966L, -2093111662L, 
-127134112L, 2031812460L, 1615209115L, 650191485L, -2110323910L, 
299242180L, -947211424L, 1051859833L, -594514057L, 264127687L, 
-1948786808L, -1593474486L, 1928610327L, 1419966832L, 1787808657L, 
-1426064477L, -1076217368L, -1131414393L, 1236066353L, 19762387L, 
-304964912L, -1110778637L, -1895081092L, 1260123360L, -774038981L, 
-2102769746L, -148554035L, 1715048867L, -936310403L, -98982245L, 
1789608879L, 1511473497L, -896100013L, -1039163264L, -1232804426L, 
1207385289L, 1586827044L, 1305600226L, -1915025658L, 45878430L, 
-1166661963L, 412823144L, -1808582130L, 677102155L, -762495888L, 
-194990678L, -1814991875L, 2111023256L, 1806541643L, 1594615332L, 
-555395435L, 104750923L, 1773696176L, -1737751784L, -1667947362L, 
1826974101L, -788649932L, -1993482053L, 134079053L, -1293360546L, 
1367475264L, -1701232227L, -920337341L, 1673399538L, -198667535L, 
-576395518L, 1706703251L, -464006388L, 1333932415L, -1175756687L, 
444229788L, -411280243L, 1694309888L, 1136006766L, -476565060L, 
1409188397L, -1865282848L, 1956499043L, -337590225L, 1481312110L, 
-571728567L, 1397761802L, 1066773372L, 2048832435L, -1194940233L, 
-1197595931L, 226852836L, 1796661197L, 197916165L, -270195412L, 
616589457L, 57075497L, -1802079272L, -639494101L, -541906818L, 
-471742149L, -274589103L, -485090508L, -1096422924L, 1022337166L, 
-1916749208L, 1613350519L, -650211698L, 648194845L, 1638402941L, 
-1467623123L, 1603701377L, -777163315L, -675049811L, -1669165464L, 
-725195550L, -785645056L, 760873753L, -642108220L, -1412240604L, 
57093370L, 349444015L, -1442072507L, -782363500L, 166376445L, 
-1164811050L, -1597395994L, 1903692478L, 1818186911L, 1298872839L, 
1493653358L, -450295151L, 512534377L, -1735227476L, -959014047L, 
1312414448L, -1502686357L, -2075245283L, -1736792158L, 1257443442L, 
-806129777L, 1070760099L, 77580860L, -1072381665L, -1857418937L, 
1912168027L, -645090640L, 1253094182L, -456824873L, 1796465654L, 
2122498224L, 1860441765L, 1127779386L, -1168846741L, 1822586773L, 
859591304L, -2052650114L, 2094276312L, -240747193L, 901496605L, 
1218059311L, 1298982112L, -2142238843L, 680332397L, 656379636L, 
-595362451L, 1582830165L, 1070527405L, -1640437193L, -107611337L, 
-1714809673L, -2083799106L, 1926484936L, -1800877798L, -426423985L, 
-887227021L, 160117611L, -2085977403L, 229786126L, 1804576454L, 
252261125L, 327269993L, -1014002533L, -1264470766L, -189196919L, 
772403507L, -2052550530L, -1895730938L, -1346553515L, 799136326L, 
-1402589310L, -1232759074L, 2067514717L, 262149404L, 1732692385L, 
-1299541123L, 155196904L, 625448700L, 2119954646L, 930363488L, 
1334408848L, 1213080993L, 1596779126L, -1381344824L, -1086469617L, 
-1259865659L, 1340808794L, 1526009021L, -734671255L, -1453620177L, 
135766787L, -1172203543L, 474165330L, 1740499044L, 1354820957L, 
2139099041L, -2053925631L, -242992569L, 760795426L, 1278325537L, 
1733524045L, 424892936L, 1374739443L, 1528039157L, 766412214L, 
155630708L, 1257794827L, -1584324366L, -1880559225L, 1167613973L, 
-281507455L, -436847258L, -1320835881L, 421112033L, 878208440L, 
1833299992L, -1461039915L, -1898081933L, -2132897107L, -223933625L, 
1639521528L, -1784953085L, 545002712L, 527487286L, -1290606108L, 
-1722021683L, -2102855772L, 609876206L, 541774944L, 544193070L, 
-1335246787L, -1829257184L, -54694446L, -1939537519L, -618110423L, 
693486004L, -1977381672L, 1289419584L, 171781483L, -1181435465L, 
1544799157L, 170869304L, 1727269971L, -1000771917L, -197900178L, 
1893667999L, 811090128L, 851783340L, -378707782L, 2065831600L, 
335225699L, -476824289L, 1509003956L, 1037088266L, -1225696462L, 
-1975352289L, -1575509547L, 495657187L, -2129025468L, 1268359463L, 
2048184543L, -177975371L, -1270002245L, -536991378L, 1687201770L, 
-364095300L, 446904402L, -2051245304L, 2124386480L, -796885523L, 
-1147677150L, 831603041L, 1101737672L, 2075011369L, 979656892L, 
-856994068L, 1224049513L, 1798460739L, 43305206L, -730319747L, 
-1736385155L, -856014453L, 814859234L, 1684157594L, 1602850510L, 
-1879716852L, 998013760L, -1047817351L, -754732146L, 516240608L, 
1280830890L, 1468202206L, 1058330005L, 369636794L, 1991467194L, 
190306239L, 323774614L, -1597100889L, -2087876640L, 1600062509L, 
956103227L, -2137843439L, 103428605L, 501260220L, 1044194986L, 
-411251492L, 1324681556L, 1222161698L, -1277633428L, -2115739568L, 
-1340068686L, -725066830L, 665763151L, 478546962L, 1821956302L, 
-997863635L, 1750977237L, -820699938L, 1173475420L, 821694997L, 
1220742311L, -1906469570L, -254522705L, -1451107046L, 2091175133L, 
-45057993L, 147321652L, 1097818866L, 367279357L, -935175031L, 
353786569L, -1744810048L, 146498185L, 1044983700L, -1812204103L, 
-1087960214L, -152264999L, 881989021L, -826277365L, -1848226061L, 
-1835415694L, 865101729L, 1064916110L, 130328243L, -1465339271L, 
-1834033080L, -1883031026L, 691549756L, -1993154947L, -591674743L, 
-1485248811L, -117533798L, -1595420412L, 773848120L, -3823L, 
-192500191L, -1166166097L, -1461104921L, -1816192529L, 432969042L, 
-467618370L, 324306049L, -23935369L, -59802384L, 471807000L, 
1496022302L, 857850103L, -2003930663L, -882144123L, -1452419768L, 
-816417697L, -1177704733L, 1244627767L, -314135110L, 50543850L, 
556083894L, -505396405L, -542418051L, 133548842L, -1046878313L, 
-2103758343L, 807456866L, 1945197520L, -650446173L, 362419668L, 
72226261L, -701989703L, -1115714240L, -1415224549L, -923736281L, 
-977862045L, -716337589L, -1165706599L, -295906892L, -2101800342L, 
-548948495L, -1438180909L, -1978505709L, 1507535589L, -330097649L, 
586976424L, -1591955875L, -1454446494L, -1886461951L, 1241949041L, 
1858887007L, 554488254L, -1150324694L, -839551280L, -79912004L, 
161746129L, -1945821750L, 1143145990L, -2044354548L, 236332674L, 
-718204290L, -1769046412L, -1501899332L, -618844343L, -1957733388L, 
-139416050L, -181073515L, 2028401629L, 938814071L, -731827493L, 
171926302L, 116452953L, -216177436L, 886041514L, 362022075L, 
-762561577L, 1693755763L, 1281665838L, 94515845L, -2026500227L, 
-1629787084L, -575853596L, -1257420712L, 2060146682L, 1149805710L
)
